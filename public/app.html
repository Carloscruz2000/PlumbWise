<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>

  <!-- PWA -->
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#0b1223">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">

  <title>PlumbWise — Revision, Resources & Mocks</title>

  <style>
    :root{
      --bg-overlay: linear-gradient(180deg,#0b1223cc 0%, #0f172acc 70%, #0f172a 100%);
      --accent: #d97706; --accent-dark: #b45309; --steel: #94a3b8;
      --panel: #0b1223; --panel-br: #1f2a44; --text: #e5e7eb;
    }
    html,body{margin:0;height:100%;background:#0f172a;color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    body{
      background-image: var(--bg-overlay),
        url('/images/bg-workshop.jpg'),
        url('/images/bg-copper.jpg');
      background-size: cover, cover, cover; background-position: center; background-attachment: fixed;
    }
    .wrap{max-width:1080px;margin:0 auto;padding:18px}
    .hero{
      background: linear-gradient(145deg,#0f172a 0%, #0b1223 50%, #0b1020 100%);
      border:1px solid #263253;border-radius:16px;padding:18px;margin:18px 0 14px 0;position:relative;overflow:hidden;
      box-shadow: 0 10px 30px #00000055;
    }
    .hero:before{content:"";position:absolute;inset:-1px;background: radial-gradient(800px 200px at 30% -10%, #1f2937aa, transparent 70%);pointer-events:none}
    .brand{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .logo{display:inline-flex;align-items:center;justify-content:center;width:56px;height:56px;border-radius:14px;
      background: radial-gradient(120% 120% at 30% 20%, #f59e0b 0%, #d97706 35%, #7c2d12 100%);border:1px solid #7c2d12;box-shadow: inset 0 0 20px #00000055, 0 6px 14px #00000055;}
    .brand h1{margin:0;font-weight:800;letter-spacing:.4px}
    .brand small{display:block;color:var(--steel)}
    .pipe{height:10px;border-radius:8px;margin:10px 0;background:
      linear-gradient(90deg, transparent 0 8px, #0000 0),
      linear-gradient(180deg,#c0841b,#8a4b0d);border:1px solid #6b3a0a;box-shadow: inset 0 2px 4px #00000055, 0 2px 10px #00000044;position:relative}
    .pipe:after{content:"";position:absolute;inset:0;background: repeating-linear-gradient(90deg, #ffffff22 0 2px, #0000 2px 10px);mix-blend-mode:overlay;border-radius:8px}
    .card{background:var(--panel);border:1px solid var(--panel-br);border-radius:12px;padding:16px;margin:14px 0}
    .btn{display:inline-block;padding:10px 14px;border:1px solid #27324f;border-radius:10px;text-decoration:none;color:var(--text);background:#111a33;cursor:pointer;transition:transform .05s ease}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:var(--accent);border-color:var(--accent)}
    .btn.primary:hover{background:var(--accent-dark)}
    .muted{color:var(--steel)}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px}
    .note{background:#0d172f;border:1px solid #223055;padding:12px;border-radius:10px}
    ul{margin:0;padding-left:20px;line-height:1.8}
    li{margin:4px 0}
    .opt{display:block;margin:8px 0}
    .viewer-modal{position:fixed;inset:0;background:#000a;display:flex;align-items:center;justify-content:center;z-index:9999}
    .viewer-box{background:var(--panel);border:1px solid var(--panel-br);border-radius:12px;width:min(1000px,95vw);height:min(90vh,850px);position:relative;overflow:hidden}
    .viewer-top{position:absolute;top:8px;right:8px;display:flex;gap:8px;z-index:2}
    .wm{position:absolute;inset:0;pointer-events:none;display:flex;align-items:center;justify-content:center;color:#ffffff12;font-size:62px;font-weight:900;letter-spacing:3px;transform:rotate(-18deg);z-index:1}
    .pdf-embed{position:absolute;inset:0;border:0;width:100%;height:100%;z-index:0}
    .banner{margin:10px 0;padding:10px;border-radius:10px;background:#1f2937d0;border:1px solid #334155;color:var(--text);font-size:14px;backdrop-filter: blur(2px)}
    .banner a{color:#93c5fd}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="hero">
      <div class="brand">
        <button class="btn" type="button" onclick="home()" aria-label="Home">← Home</button>
        <div class="logo" aria-hidden="true">
          <svg width="34" height="34" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <circle cx="12" cy="12" r="8.5" stroke="rgba(0,0,0,.55)" stroke-width="3"></circle>
            <circle cx="12" cy="12" r="7.5" stroke="#1f2937" stroke-width="2"></circle>
            <path d="M7.2 7.6a4.2 4.2 0 0 0 5.6 5.6l3.6 3.6a1.2 1.2 0 0 0 1.7-1.7l-3.6-3.6a4.2 4.2 0 0 0-5.6-5.6l1.7 1.7-1.1 1.1-1.7-1.7z" fill="#111827"></path>
            <path d="M8 8a3.6 3.6 0 0 0 5.1 5.1l3.9 3.9a.8.8 0 1 0 1.1-1.1l-3.9-3.9A3.6 3.6 0 0 0 8 8z" fill="#fde68a"></path>
            <path d="M12 18c1.6 0 3-1.4 3-3.1 0-1.6-1.5-3.6-3-5.1-1.5 1.5-3 3.5-3 5.1 0 1.7 1.4 3.1 3 3.1z" fill="#60a5fa" opacity=".95"></path>
          </svg>
        </div>
        <div>
          <h1 style="margin:0;font-size:22px">PlumbWise <small class="muted">Revision, Resources & Mock Exams</small></h1>
          <small id="accessState" class="muted">Access: Locked</small>
        </div>
        <div style="margin-left:auto;display:flex;gap:8px;flex-wrap:wrap">
          <button id="subscribeBtnTop" class="btn primary" onclick="subscribe()">Subscribe (£5.99/mo)</button>
          <button id="alreadyBtnTop" class="btn" onclick="alreadySubscribed()">I already subscribed</button>
        </div>
      </div>

      <div class="pipe" aria-hidden="true"></div>
      <p class="muted" style="margin:0">Open a module → Revision to view resources.</p>

      <div id="accessBanner" class="banner" style="display:none">
        Access is locked. You need an active subscription to open resources and mocks.
        <button id="subscribeBtn" class="btn primary" style="margin-left:8px" onclick="subscribe()">Subscribe (£5.99/mo)</button>
        <button id="alreadyBtn" class="btn" style="margin-left:6px" onclick="alreadySubscribed()">I already subscribed</button>
      </div>
    </header>

    <main id="app"></main>
  </div>

  <script>
  document.addEventListener('contextmenu', e => e.preventDefault());

  const MODULES = [
    { id: "hs",   title: "Health & Safety" },
    { id: "elec", title: "Electrical" },
    { id: "sci",  title: "Scientific Principles" },
    { id: "proc", title: "Plumbing Processes" },
    { id: "cold", title: "Cold Water" },
    { id: "hot",  title: "Hot Water" },
    { id: "ch",   title: "Central Heating" },
    { id: "san",  title: "Sanitation" },
    { id: "drn",  title: "Drainage" },
    { id: "comm", title: "Communications" },
    { id: "wr",   title: "Water Regulations" }
  ];

  const NOTES = {
    hs:["PPE, COSHH, permits, safe isolation."],
    elec:["RCDs, bonding/earthing, prove–test–prove."],
    sci:["Pressure≈ρgh; 10 m head≈1 bar; expansion control."],
    proc:["Measure, deburr/clean, heat fitting (not solder), press-fit jaw/profile."],
    cold:["Isolation, DCV/backflow, avoid dead legs."],
    hot:["Store ~60°C+, TMVs, unvented safety set & tundish."],
    ch:["Sealed systems: expansion vessel, PRV, inhibitor, balance."],
    san:["50 mm water seal, venting/anti-siphon, correct falls."],
    drn:["100 mm pipe ≈ 18–90 mm/m fall, rodding points at changes."],
    comm:["Confirm scope/changes in writing, keep photos/test records."],
    wr:["WRAS fittings, backflow categories, notify where required."]
  };

  const RES = {
    hs: [
      { label: "6035 Health and Safety PowerPoint 1", file: "/resources/hs/6035 Health and safety powerpoint 1.pdf" },
      { label: "6035 Health and Safety PowerPoint 2", file: "/resources/hs/6035 Health and safety powerpoint 2.pdf" },
      { label: "6035 Health and Safety PowerPoint 3", file: "/resources/hs/6035 Health and safety powerpoint 3.pdf" },
      { label: "6035 Health and Safety PowerPoint 4", file: "/resources/hs/6035 Health and safety powerpoint 4.pdf" },
      { label: "6035 Health and Safety PowerPoint 5", file: "/resources/hs/6035 Health and safety powerpoint 5.pdf" },
      { label: "6035 Health and Safety PowerPoint 6", file: "/resources/hs/6035 Health and safety powerpoint 6.pdf" },
      { label: "Health and Safety Revision Study Pack 2014 (reduced)", file: "/resources/hs/Health and Safety Revision Study Pack 2014 reduced.pdf" }
    ],
    elec: [
      { label: "6035 Electrical 1", file: "/resources/elec/6035 electrical 1.pdf" },
      { label: "6035 Electrical 2", file: "/resources/elec/6035 electrical 2.pdf" },
      { label: "6035 Electrical 3", file: "/resources/elec/6035 electrical 3.pdf" },
      { label: "6035 Electrical 5", file: "/resources/elec/6035 electrical 5.pdf" },
      { label: "6035 Electrical 6", file: "/resources/elec/6035 electrical 6.pdf" }
    ],
    sci: [
      { label: "6035 L2 U203 Science 1", file: "/resources/sci/6035_l2u203_Science 1.pdf" },
      { label: "6035 L2 U203 Science 2", file: "/resources/sci/6035_l2u203_Science 2.pdf" },
      { label: "6035 L2 U203 Science 3", file: "/resources/sci/6035_l2u203_Science 3.pdf" },
      { label: "6035 L2 U203 Science 4", file: "/resources/sci/6035_l2u203_Science 4.pdf" },
      { label: "6035 L2 U203 Science 5", file: "/resources/sci/6035_l2u203_Science 5.pdf" },
      { label: "6035 L2 U203 Science 6", file: "/resources/sci/6035_l2u203_Science 6.pdf" },
      { label: "Key Plumbing Principles Level 2 Revision", file: "/resources/sci/Key Plumbing Principles level 2 Revision.pdf" }
    ],
    proc: [
      { label: "6035 L2 U204 Outcome 1", file: "/resources/proc/6035_l2u204_ppt_outcome1.pdf" },
      { label: "6035 L2 U204 Outcome 3", file: "/resources/proc/6035_l2u204_ppt_outcome3.pdf" },
      { label: "6035 L2 U204 Outcome 4", file: "/resources/proc/6035_l2u204_ppt_outcome4.pdf" },
      { label: "6035 L2 U204 Outcome 5", file: "/resources/proc/6035_l2u204_ppt_outcome5.pdf" },
      { label: "6035 L2 U204 Outcome 6", file: "/resources/proc/6035_l2u204_ppt_outcome6.pdf" },
      { label: "6035 L2 U204 Outcome 7", file: "/resources/proc/6035_l2u204_ppt_outcome7.pdf" }
    ],
    cold: [
      { label: "6035 L2 U205 Outcome 1", file: "/resources/cold/6035_l2u205_ppt_outcome1.pdf" },
      { label: "6035 L2 U205 Outcome 2", file: "/resources/cold/6035_l2u205_ppt_outcome2.pdf" },
      { label: "6035 L2 U205 Outcome 3", file: "/resources/cold/6035_l2u205_ppt_outcome3.pdf" },
      { label: "6035 L2 U205 Outcome 4", file: "/resources/cold/6035_l2u205_ppt_outcome4.pdf" },
      { label: "6035 L2 U205 Outcome 5", file: "/resources/cold/6035_l2u205_ppt_outcome5.pdf" },
      { label: "6035 L2 U205 Outcome 6", file: "/resources/cold/6035_l2u205_ppt_outcome6.pdf" }
    ],
    hot: [
      { label: "6035 L2 U206 Outcome 1 (Part 1)", file: "/resources/hot/6035_l2u206_ppt_outcome1_part_1.pdf" },
      { label: "6035 L2 U206 Outcome 1 (Part 2)", file: "/resources/hot/6035_l2u206_ppt_outcome1_part_2.pdf" },
      { label: "6035 L2 U206 Outcome 2", file: "/resources/hot/6035_l2u206_ppt_outcome2.pdf" },
      { label: "6035 L2 U206 Outcome 3 (Part 1)", file: "/resources/hot/6035_l2u206_ppt_outcome3_part_1.pdf" },
      { label: "6035 L2 U206 Outcome 3 (Part 2)", file: "/resources/hot/6035_l2u206_ppt_outcome3_part_2.pdf" },
      { label: "6035 L2 U206 Outcome 4", file: "/resources/hot/6035_l2u206_ppt_outcome4.pdf" },
      { label: "6035 L2 U206 Outcome 5", file: "/resources/hot/6035_l2u206_ppt_outcome5.pdf" },
      { label: "6035 L2 U206 Outcome 6", file: "/resources/hot/6035_l2u206_ppt_outcome6.pdf" }
    ],
    ch: [
      { label: "6035 L2 U208 Outcome 1 (Part 1)", file: "/resources/ch/6035_l2u208_ppt_outcome1_part_1.pdf" },
      { label: "6035 L2 U208 Outcome 1 (Part 2)", file: "/resources/ch/6035_l2u208_ppt_outcome1_part_2.pdf" },
      { label: "6035 L2 U208 Outcome 1 (Part 3)", file: "/resources/ch/6035_l2u208_ppt_outcome1_part_3.pdf" },
      { label: "6035 L2 U208 Outcome 2", file: "/resources/ch/6035_l2u208_ppt_outcome2.pdf" },
      { label: "6035 L2 U208 Outcome 3 (Part 1)", file: "/resources/ch/6035_l2u208_ppt_outcome3_part_1.pdf" },
      { label: "6035 L2 U208 Outcome 3 (Part 2)", file: "/resources/ch/6035_l2u208_ppt_outcome3_part_2.pdf" },
      { label: "6035 L2 U208 Outcome 4", file: "/resources/ch/6035_l2u208_ppt_outcome4.pdf" }
    ],
    san: [
      { label: "6035 L2 U209 Outcome 1 (Part 1)", file: "/resources/san/6035_l2u209_ppt_outcome1_part_1.pdf" },
      { label: "6035 L2 U209 Outcome 1 (Part 2)", file: "/resources/san/6035_l2u209_ppt_outcome1_part_2.pdf" },
      { label: "6035 L2 U209 Outcome 1 (Part 3)", file: "/resources/san/6035_l2u209_ppt_outcome1_part_3.pdf" },
      { label: "6035 L2 U209 Outcome 2 (Part 1)", file: "/resources/san/6035_l2u209_ppt_outcome2_part_1.pdf" },
      { label: "6035 L2 U209 Outcome 2 (Part 2)", file: "/resources/san/6035_l2u209_ppt_outcome2_part_2.pdf" },
      { label: "6035 L2 U209 Outcome 3", file: "/resources/san/6035_l2u209_ppt_outcome3.pdf" },
      { label: "6035 L2 U209 Outcome 4 (Part 1)", file: "/resources/san/6035_l2u209_ppt_outcome4_part_1.pdf" },
      { label: "6035 L2 U209 Outcome 4 (Part 2)", file: "/resources/san/6035_l2u209_ppt_outcome4_part_2.pdf" },
      { label: "6035 L2 U209 Outcome 4 (Part 3)", file: "/resources/san/6035_l2u209_ppt_outcome4_part_3.pdf" },
      { label: "6035 L2 U209 Outcome 4 (Part 4)", file: "/resources/san/6035_l2u209_ppt_outcome4_part_4.pdf" }
    ],
    drn: [],
    comm: [
      { label: "6035 Communication 1", file: "/resources/comm/6035 communication 1.pdf" },
      { label: "6035 Communication 2", file: "/resources/comm/6035 communication 2.pdf" },
      { label: "6035 Communication 3", file: "/resources/comm/6035 communication 3.pdf" },
      { label: "Effective Working Relationships Level 2 Revision", file: "/resources/comm/Effective Working Relationships Level 2 Revision.pdf" }
    ],
    wr: []
  };

  const QB = {
    hs:[{ q:"First step before hot works?", type:"mcq", options:["Warn others","Open window","Risk assessment/permit","Put on gloves"], answer:[2], why:"Control hazards before starting." }],
    elec:[{ q:"Safe isolation requires:", type:"multi", options:["Prove tester","Test supply","Lock-off","Skip proving"], answer:[0,1,2], why:"Prove, test, secure." }],
    sci:[{ q:"1 m head ≈ ?", type:"mcq", options:["0.01 bar","0.1 bar","1 bar","10 bar"], answer:[1], why:"~10 m ≈ 1 bar." }]
  };

  const app = document.getElementById("app");
  const shuffle = a => { for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; };

  /* Access & subscription helpers */
  function reflectAccessUI(){
    const badge = document.getElementById("accessState");
    if (badge) badge.textContent = isActive() ? "Access: Active" : "Access: Locked";
    const subTop = document.getElementById("subscribeBtnTop");
    const subInline = document.getElementById("subscribeBtn");
    if (subTop)    subTop.style.display    = isActive() ? "none" : "";
    if (subInline) subInline.style.display = isActive() ? "none" : "";
    const banner = document.getElementById("accessBanner");
    banner.style.display = isActive() ? "none" : "block";
  }
  function setActive(email, active){
    if (active) {
      localStorage.setItem("plumbwise_active","1");
      if (email) localStorage.setItem("plumbwise_email", email);
    } else {
      localStorage.removeItem("plumbwise_active");
    }
    reflectAccessUI();
  }
  function isActive(){ return localStorage.getItem("plumbwise_active")==="1"; }
  function savedEmail(){ return localStorage.getItem("plumbwise_email") || ""; }

  async function verifyByEmailSilently(){
    const email = savedEmail(); if (!email) return;
    try {
      const res = await fetch("/api/subscription-status", {
        method:"POST", headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ email })
      });
      const data = await res.json();
      setActive(email, !!data.active);
    } catch {}
  }
  async function confirmFromSessionId(){
    const sid = new URLSearchParams(location.search).get("session_id");
    if (!sid) return;
    const res = await fetch("/api/subscription-status", {
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ session_id: sid })
    });
    const data = await res.json();
    if (data.active) {
      setActive(data.email || savedEmail(), true);
      history.replaceState({}, "", location.pathname);
      alert("Subscription active – thanks!");
    }
  }
  async function requireActive(){
    if (isActive()) return true;
    reflectAccessUI(); // show banner, no popups
    return false;
  }

  /* Viewer */
  function encodePath(p){ return p.split('/').map((seg,i)=> i===0?seg:encodeURIComponent(seg)).join('/'); }
  function _openInline(raw){
    const file = encodePath(raw);
    const src = file + '#toolbar=0&navpanes=0&scrollbar=0&view=FitH';
    const modal = document.createElement('div');
    modal.className='viewer-modal';
    modal.innerHTML = `
      <div class="viewer-box">
        <div class="viewer-top">
          <button class="btn" onclick="this.closest('.viewer-modal').remove()">Close</button>
          <button class="btn" onclick="window.open('${file}','_blank','noopener,noreferrer')">Open in new tab</button>
        </div>
        <div class="wm">PLUMBWISE</div>
        <embed class="pdf-embed" src="${src}" type="application/pdf" />
      </div>`;
    document.body.appendChild(modal);
    setTimeout(() => {
      const ok = modal.querySelector('.pdf-embed')?.offsetHeight > 0;
      if (!ok) { window.open(file, "_blank", "noopener,noreferrer"); modal.remove(); }
    }, 500);
  }
  window.openInline = async (p)=>{ if (!(await requireActive())) return; _openInline(p); };

  /* Quiz */
  const _startQuiz = (id)=>{ 
    const qs = (QB[id]||[]).map((q,i)=>({...q,_id:`${id}_${i}`}));
    if(!qs.length){ alert("No questions in this module yet."); return; }
    window._q = { idx:0, order:shuffle([...qs.keys()]), pool:qs, answers:{}, title:`${MODULES.find(m=>m.id===id).title} — Mock` };
    renderQ();
  };
  window.startQuiz = async (id)=>{ if (!(await requireActive())) return; _startQuiz(id); };

  function home(){
    const cards = MODULES.map(m=>`
      <div class="card" style="backdrop-filter: blur(2px);">
        <h2>${m.title}</h2>
        <div class="note">${(NOTES[m.id]||[])[0]||""}</div>
        <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap">
          <button class="btn" type="button" onclick="revision('${m.id}')">Revision</button>
          <button class="btn primary" type="button" onclick="startQuiz('${m.id}')">Mock Exam</button>
        </div>
      </div>
    `).join("");
    app.innerHTML = `<section class="grid">${cards}</section>`;
  }

  function revision(id){
    const mod = MODULES.find(m=>m.id===id);
    const notes = NOTES[id] || [];
    const files = RES[id] || [];
    app.innerHTML = `
      <div class="card" style="backdrop-filter: blur(2px);">
        <h2>${mod.title} — Revision</h2>
        ${notes.length ? notes.map(n=>`<div class="note">${n}</div>`).join("") : `<div class="note">No notes yet.</div>`}
        ${ files.length ? `
          <div class="card" style="margin-top:12px">
            <h3>Resources</h3>
            <ul>
              ${files.map(r=>`<li>
                <button class="btn" type="button" onclick="openInline('${r.file}')">View</button>
                <span class="muted" style="margin-left:8px">${r.label}</span>
              </li>`).join("")}
            </ul>
            <p class="muted">Viewing only. Browser toolbars may still appear; screenshots can’t be fully prevented.</p>
          </div>` : ``}
        <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap">
          <button class="btn primary" type="button" onclick="startQuiz('${id}')">Start Mock</button>
          <button class="btn" type="button" onclick="home()">← Back</button>
        </div>
      </div>
    `;
  }

  function renderQ(){
    const s=window._q; if(!s)return;
    const i=s.order[s.idx], q=s.pool[i], cur=s.idx+1, total=s.pool.length, sel=s.answers[q._id]||[];
    const opts = (q.type==="multi")
      ? q.options.map((o,idx)=>`<label class="opt"><input type="checkbox" ${sel.includes(idx)?"checked":""} onchange="toggleMulti('${q._id}',${idx})"/> ${o}</label>`).join("")
      : q.options.map((o,idx)=>`<label class="opt"><input type="radio" name="opt" ${sel.includes(idx)?"checked":""} onchange="pickOne('${q._id}',${idx})"/> ${o}</label>`).join("");

    app.innerHTML = `
      <div class="card" style="backdrop-filter: blur(2px);">
        <h2>${s.title} (${cur}/${total})</h2>
        <b>${q.q}</b><div>${opts}</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn" type="button" onclick="prevQ()">Back</button>
          <button class="btn" type="button" onclick="nextQ()">Next</button>
          <button class="btn primary" type="button" onclick="submitQ()">Submit</button>
        </div>
        <p class="muted" style="margin-top:8px">${q.type==="multi"?"Select all that apply":"Select one"}.</p>
      </div>`;
  }
  function pickOne(id,idx){const s=window._q;s.answers[id]=[idx];renderQ();}
  function toggleMulti(id,idx){const s=window._q;const set=new Set(s.answers[id]||[]);set.has(idx)?set.delete(idx):set.add(idx);s.answers[id]=[...set].sort((a,b)=>a-b);renderQ();}
  function nextQ(){const s=window._q;if(s.idx<s.pool.length-1)s.idx++;renderQ();}
  function prevQ(){const s=window._q;if(s.idx>0)s.idx--;renderQ();}
  function submitQ(){
    const s=window._q;let correct=0;
    s.pool.forEach(q=>{const a=s.answers[q._id]||[],ans=(q.answer||[]).slice().sort((x,y)=>x-y);
      const ok=a.length===ans.length&&a.every((v,i)=>v===ans[i]); if(ok)correct++;});
    alert("Score: "+correct+"/"+s.pool.length);
    home();
  }

  async function subscribe() {
    const email = prompt("Enter your email to subscribe (receipt will be sent here):");
    if (!email) return;
    localStorage.setItem("plumbwise_email", email);
    try {
      const res = await fetch("/api/checkout", {
        method: "POST", headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email })
      });
      const data = await res.json();
      if (data.url) window.location = data.url;
      else alert("Checkout failed: " + (data.error || "Unknown error"));
    } catch { alert("Network error starting checkout."); }
  }
  async function alreadySubscribed(){
    const email = prompt("Enter the email you used to subscribe:");
    if (!email) return;
    localStorage.setItem("plumbwise_email", email);
    try{
      const r = await fetch("/api/subscription-status",{
        method:"POST",headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ email })
      });
      const d = await r.json();
      setActive(email, !!d.active);
      if(!d.active) alert("No active subscription found for that email (check Stripe test vs live).");
    }catch{}
  }

  window.addEventListener('DOMContentLoaded', async () => {
    reflectAccessUI();
    await confirmFromSessionId();
    await verifyByEmailSilently();
    home();
  });
  </script>

  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("/sw.js").catch(()=>{});
    }
  </script>
  <script src="/js/quizzes-hs.js"></script>
  <script src="/js/quizzes-elec.js"></script>
  <script src="/js/quizzes-sci.js"></script>
  <script src="/js/quizzes-proc.js"></script>
  <script src="/js/quizzes-cold.js"></script>
</body>
</html>
