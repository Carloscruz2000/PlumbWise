<!doctype html>
<html lang="en">
<head>
 <button class="btn" onclick="alreadySubscribed()">I already subscribed</button>
 <span id="accessState" class="muted" style="margin-left:8px">Access: Locked</span> 
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>

  <!-- PWA -->
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#1e3a8a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">

  <title>PlumbWise — Revision, Resources & Mocks</title>

  <style>
    html,body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:#0f172a;color:#e5e7eb}
    .wrap{max-width:960px;margin:0 auto;padding:18px}
    .card{background:#0b1223;border:1px solid #1f2a44;border-radius:12px;padding:16px;margin:14px 0}
    .btn{display:inline-block;padding:10px 14px;border:1px solid #27324f;border-radius:10px;text-decoration:none;color:#e5e7eb;background:#111a33;cursor:pointer}
    .btn.primary{background:#2563eb;border-color:#2563eb}
    .btn.primary:hover{background:#1e4fd1}
    .muted{color:#94a3b8}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px}
    .note{background:#0d172f;border:1px solid #223055;padding:12px;border-radius:10px}
    ul{margin:0;padding-left:20px;line-height:1.8}
    li{margin:4px 0}
    .opt{display:block;margin:8px 0}
    /* Inline viewer */
    .viewer-modal{position:fixed;inset:0;background:#000a;display:flex;align-items:center;justify-content:center;z-index:9999}
    .viewer-box{background:#0b1223;border:1px solid #1f2a44;border-radius:12px;width:min(1000px,95vw);height:min(90vh,850px);position:relative;overflow:hidden}
    .viewer-top{position:absolute;top:8px;right:8px;display:flex;gap:8px;z-index:2}
    .wm{position:absolute;inset:0;pointer-events:none;display:flex;align-items:center;justify-content:center;color:#ffffff1f;font-size:60px;font-weight:800;letter-spacing:2px;transform:rotate(-20deg);z-index:1}
    .pdf-embed{position:absolute;inset:0;border:0;width:100%;height:100%;z-index:0}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="card">
      <a class="btn" href="/">← Home</a>
      <h1>PlumbWise — Revision, Resources & Mock Exams</h1>
      <p class="muted">Open a module → Revision to view resources. Downloads are discouraged.</p>
      <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap">
        <button class="btn primary" onclick="subscribe()">Subscribe (£5.99/mo)</button>
      </div>
    </header>
    <main id="app"></main>
  </div>

  <script>
// --- Access state helpers ---
function setActive(email, active) {
  const el = document.getElementById("accessState");
  if (active) {
    localStorage.setItem("plumbwise_active", "1");
    if (email) localStorage.setItem("plumbwise_email", email);
    if (el) el.textContent = "Access: Active";
  } else {
    localStorage.removeItem("plumbwise_active");
    if (el) el.textContent = "Access: Locked";
  }
}
function isActive(){ return localStorage.getItem("plumbwise_active") === "1"; }
function savedEmail(){ return localStorage.getItem("plumbwise_email") || ""; }

// After returning from Stripe: confirm using session_id
async function confirmFromSessionId(){
  const params = new URLSearchParams(location.search);
  const sid = params.get("session_id");
  if (!sid) return;
  try {
    const res = await fetch("/api/subscription-status", {
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ session_id: sid })
    });
    const data = await res.json();
    if (data.active) {
      setActive(data.email, true);
      history.replaceState({}, "", location.pathname); // remove ?session_id from URL
      alert("Subscription active – thanks!");
    } else {
      setActive(null, false);
      alert("Couldn’t confirm your subscription yet. If you paid, try Refresh.");
    }
  } catch (e) {
    console.warn(e);
  }
}

// For later visits: verify by email
async function recheckByEmail(){
  const email = savedEmail() || prompt("Enter your subscription email to check access:");
  if (!email) return false;
  localStorage.setItem("plumbwise_email", email);
  const res = await fetch("/api/subscription-status", {
    method:"POST", headers:{"Content-Type":"application/json"},
    body: JSON.stringify({ email })
  });
  const data = await res.json();
  setActive(email, !!data.active);
  return !!data.active;
}

// Gate resource/quiz actions
async function requireActive(){
  if (isActive()) return true;
  const ok = await recheckByEmail();
  if (!ok) {
    const go = confirm("Subscription required to access. Subscribe now?");
    if (go) subscribe();
  }
  return ok;
}

// Wrap your openInline and startQuiz
const _openInline = window.openInline;
window.openInline = async function(p){
  if (!(await requireActive())) return;
  return _openInline(p);
};
const _startQuiz = window.startQuiz;
window.startQuiz = async function(id){
  if (!(await requireActive())) return;
  return _startQuiz(id);
};

// Make Subscribe remember email so rechecks work
async function subscribe() {
  const email = prompt("Enter your email to subscribe (receipt will be sent here):");
  if (!email) return;
  localStorage.setItem("plumbwise_email", email);
  try {
    const res = await fetch("/api/checkout", {
      method: "POST", headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email })
    });
    const data = await res.json();
    if (data.url) window.location = data.url;
    else alert("Checkout failed: " + (data.error || "Unknown error"));
  } catch { alert("Network error starting checkout."); }
}

// On load: reflect current state and confirm from session_id if present
window.addEventListener("DOMContentLoaded", () => {
  setActive(savedEmail(), isActive());
  confirmFromSessionId();
});
</script>
  // Prevent easy right-click saving (not bulletproof)
  document.addEventListener('contextmenu', e => e.preventDefault());

  // --- Data ---
  const MODULES = [
    { id: "hs",   title: "Health & Safety" },
    { id: "elec", title: "Electrical" },
    { id: "sci",  title: "Scientific Principles" },
    { id: "proc", title: "Plumbing Processes" },
    { id: "cold", title: "Cold Water" },
    { id: "hot",  title: "Hot Water" },
    { id: "ch",   title: "Central Heating" },
    { id: "san",  title: "Sanitation" },
    { id: "drn",  title: "Drainage" },
    { id: "comm", title: "Communications" },
    { id: "wr",   title: "Water Regulations" }
  ];

  const NOTES = {
    hs:["PPE, COSHH, permits, safe isolation."],
    elec:["RCDs, bonding/earthing, prove–test–prove."],
    sci:["Pressure≈ρgh; 10 m head≈1 bar; expansion control."],
    proc:["Measure, deburr/clean, heat fitting (not solder), press-fit jaw/profile."],
    cold:["Isolation, DCV/backflow, avoid dead legs."],
    hot:["Store ~60°C+, TMVs, unvented safety set & tundish."],
    ch:["Sealed systems: expansion vessel, PRV, inhibitor, balance."],
    san:["50 mm water seal, venting/anti-siphon, correct falls."],
    drn:["100 mm pipe ≈ 18–90 mm/m fall, rodding points at changes."],
    comm:["Confirm scope/changes in writing, keep photos/test records."],
    wr:["WRAS fittings, backflow categories, notify where required."]
  };

  const RES = {
    hs: [
      { label: "6035 Health and Safety PowerPoint 1", file: "/resources/hs/6035 Health and safety powerpoint 1.pdf" },
      { label: "6035 Health and Safety PowerPoint 2", file: "/resources/hs/6035 Health and safety powerpoint 2.pdf" },
      { label: "6035 Health and Safety PowerPoint 3", file: "/resources/hs/6035 Health and safety powerpoint 3.pdf" },
      { label: "6035 Health and Safety PowerPoint 4", file: "/resources/hs/6035 Health and safety powerpoint 4.pdf" },
      { label: "6035 Health and Safety PowerPoint 5", file: "/resources/hs/6035 Health and safety powerpoint 5.pdf" },
      { label: "6035 Health and Safety PowerPoint 6", file: "/resources/hs/6035 Health and safety powerpoint 6.pdf" },
      { label: "Health and Safety Revision Study Pack 2014 (reduced)", file: "/resources/hs/Health and Safety Revision Study Pack 2014 reduced.pdf" }
    ],
    elec: [
      { label: "6035 Electrical 1", file: "/resources/elec/6035 electrical 1.pdf" },
      { label: "6035 Electrical 2", file: "/resources/elec/6035 electrical 2.pdf" },
      { label: "6035 Electrical 3", file: "/resources/elec/6035 electrical 3.pdf" },
      { label: "6035 Electrical 5", file: "/resources/elec/6035 electrical 5.pdf" },
      { label: "6035 Electrical 6", file: "/resources/elec/6035 electrical 6.pdf" }
    ],
    sci: [
      { label: "6035 L2 U203 Science 1", file: "/resources/sci/6035_l2u203_Science 1.pdf" },
      { label: "6035 L2 U203 Science 2", file: "/resources/sci/6035_l2u203_Science 2.pdf" },
      { label: "6035 L2 U203 Science 3", file: "/resources/sci/6035_l2u203_Science 3.pdf" },
      { label: "6035 L2 U203 Science 4", file: "/resources/sci/6035_l2u203_Science 4.pdf" },
      { label: "6035 L2 U203 Science 5", file: "/resources/sci/6035_l2u203_Science 5.pdf" },
      { label: "6035 L2 U203 Science 6", file: "/resources/sci/6035_l2u203_Science 6.pdf" },
      { label: "Key Plumbing Principles Level 2 Revision", file: "/resources/sci/Key Plumbing Principles level 2 Revision.pdf" }
    ],
    proc: [
      { label: "6035 L2 U204 Outcome 1", file: "/resources/proc/6035_l2u204_ppt_outcome1.pdf" },
      { label: "6035 L2 U204 Outcome 3", file: "/resources/proc/6035_l2u204_ppt_outcome3.pdf" },
      { label: "6035 L2 U204 Outcome 4", file: "/resources/proc/6035_l2u204_ppt_outcome4.pdf" },
      { label: "6035 L2 U204 Outcome 5", file: "/resources/proc/6035_l2u204_ppt_outcome5.pdf" },
      { label: "6035 L2 U204 Outcome 6", file: "/resources/proc/6035_l2u204_ppt_outcome6.pdf" },
      { label: "6035 L2 U204 Outcome 7", file: "/resources/proc/6035_l2u204_ppt_outcome7.pdf" }
    ],
    cold: [
      { label: "6035 L2 U205 Outcome 1", file: "/resources/cold/6035_l2u205_ppt_outcome1.pdf" },
      { label: "6035 L2 U205 Outcome 2", file: "/resources/cold/6035_l2u205_ppt_outcome2.pdf" },
      { label: "6035 L2 U205 Outcome 3", file: "/resources/cold/6035_l2u205_ppt_outcome3.pdf" },
      { label: "6035 L2 U205 Outcome 4", file: "/resources/cold/6035_l2u205_ppt_outcome4.pdf" },
      { label: "6035 L2 U205 Outcome 5", file: "/resources/cold/6035_l2u205_ppt_outcome5.pdf" },
      { label: "6035 L2 U205 Outcome 6", file: "/resources/cold/6035_l2u205_ppt_outcome6.pdf" }
    ],
    hot: [
      { label: "6035 L2 U206 Outcome 1 (Part 1)", file: "/resources/hot/6035_l2u206_ppt_outcome1_part_1.pdf" },
      { label: "6035 L2 U206 Outcome 1 (Part 2)", file: "/resources/hot/6035_l2u206_ppt_outcome1_part_2.pdf" },
      { label: "6035 L2 U206 Outcome 2", file: "/resources/hot/6035_l2u206_ppt_outcome2.pdf" },
      { label: "6035 L2 U206 Outcome 3 (Part 1)", file: "/resources/hot/6035_l2u206_ppt_outcome3_part_1.pdf" },
      { label: "6035 L2 U206 Outcome 3 (Part 2)", file: "/resources/hot/6035_l2u206_ppt_outcome3_part_2.pdf" },
      { label: "6035 L2 U206 Outcome 4", file: "/resources/hot/6035_l2u206_ppt_outcome4.pdf" },
      { label: "6035 L2 U206 Outcome 5", file: "/resources/hot/6035_l2u206_ppt_outcome5.pdf" },
      { label: "6035 L2 U206 Outcome 6", file: "/resources/hot/6035_l2u206_ppt_outcome6.pdf" }
    ],
    ch: [
      { label: "6035 L2 U208 Outcome 1 (Part 1)", file: "/resources/ch/6035_l2u208_ppt_outcome1_part_1.pdf" },
      { label: "6035 L2 U208 Outcome 1 (Part 2)", file: "/resources/ch/6035_l2u208_ppt_outcome1_part_2.pdf" },
      { label: "6035 L2 U208 Outcome 1 (Part 3)", file: "/resources/ch/6035_l2u208_ppt_outcome1_part_3.pdf" },
      { label: "6035 L2 U208 Outcome 2", file: "/resources/ch/6035_l2u208_ppt_outcome2.pdf" },
      { label: "6035 L2 U208 Outcome 3 (Part 1)", file: "/resources/ch/6035_l2u208_ppt_outcome3_part_1.pdf" },
      { label: "6035 L2 U208 Outcome 3 (Part 2)", file: "/resources/ch/6035_l2u208_ppt_outcome3_part_2.pdf" },
      { label: "6035 L2 U208 Outcome 4", file: "/resources/ch/6035_l2u208_ppt_outcome4.pdf" }
    ],
    san: [
      { label: "6035 L2 U209 Outcome 1 (Part 1)", file: "/resources/san/6035_l2u209_ppt_outcome1_part_1.pdf" },
      { label: "6035 L2 U209 Outcome 1 (Part 2)", file: "/resources/san/6035_l2u209_ppt_outcome1_part_2.pdf" },
      { label: "6035 L2 U209 Outcome 1 (Part 3)", file: "/resources/san/6035_l2u209_ppt_outcome1_part_3.pdf" },
      { label: "6035 L2 U209 Outcome 2 (Part 1)", file: "/resources/san/6035_l2u209_ppt_outcome2_part_1.pdf" },
      { label: "6035 L2 U209 Outcome 2 (Part 2)", file: "/resources/san/6035_l2u209_ppt_outcome2_part_2.pdf" },
      { label: "6035 L2 U209 Outcome 3", file: "/resources/san/6035_l2u209_ppt_outcome3.pdf" },
      { label: "6035 L2 U209 Outcome 4 (Part 1)", file: "/resources/san/6035_l2u209_ppt_outcome4_part_1.pdf" },
      { label: "6035 L2 U209 Outcome 4 (Part 2)", file: "/resources/san/6035_l2u209_ppt_outcome4_part_2.pdf" },
      { label: "6035 L2 U209 Outcome 4 (Part 3)", file: "/resources/san/6035_l2u209_ppt_outcome4_part_3.pdf" },
      { label: "6035 L2 U209 Outcome 4 (Part 4)", file: "/resources/san/6035_l2u209_ppt_outcome4_part_4.pdf" }
    ],
    drn: [],
    comm: [
      { label: "6035 Communication 1", file: "/resources/comm/6035 communication 1.pdf" },
      { label: "6035 Communication 2", file: "/resources/comm/6035 communication 2.pdf" },
      { label: "6035 Communication 3", file: "/resources/comm/6035 communication 3.pdf" },
      { label: "Effective Working Relationships Level 2 Revision", file: "/resources/comm/Effective Working Relationships Level 2 Revision.pdf" }
    ],
    wr: []
  };

  const QB = {
    hs:[{ q:"First step before hot works?", type:"mcq", options:["Warn others","Open window","Risk assessment/permit","Put on gloves"], answer:[2], why:"Control hazards before starting." }],
    elec:[{ q:"Safe isolation requires:", type:"multi", options:["Prove tester","Test supply","Lock-off","Skip proving"], answer:[0,1,2], why:"Prove, test, secure." }],
    sci:[{ q:"1 m head ≈ ?", type:"mcq", options:["0.01 bar","0.1 bar","1 bar","10 bar"], answer:[1], why:"~10 m ≈ 1 bar." }]
  };

  const app = document.getElementById("app");
  const shuffle = a => { for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; };

  // --- Safer viewer (encodes each segment, no HEAD pre-check) ---
  function encodePath(p){ return p.split('/').map((seg,i)=> i===0?seg:encodeURIComponent(seg)).join('/'); }
  function openInline(raw){
    const file = encodePath(raw);
    const src = file + '#toolbar=0&navpanes=0&scrollbar=0&view=FitH';
    const modal = document.createElement('div');
    modal.className='viewer-modal';
    modal.innerHTML = `
      <div class="viewer-box">
        <div class="viewer-top">
          <button class="btn" onclick="this.closest('.viewer-modal').remove()">Close</button>
          <button class="btn" onclick="window.open('${file}','_blank','noopener,noreferrer')">Open in new tab</button>
        </div>
        <div class="wm">PLUMBWISE</div>
        <embed class="pdf-embed" src="${src}" type="application/pdf" />
      </div>`;
    document.body.appendChild(modal);

    // Fallback: if embed fails to render, pop new tab
    setTimeout(() => {
      const ok = modal.querySelector('.pdf-embed')?.offsetHeight > 0;
      if (!ok) { window.open(file, "_blank", "noopener,noreferrer"); modal.remove(); }
    }, 500);
  }

  // --- Screens ---
  function home(){
    const cards = MODULES.map(m=>`
      <div class="card">
        <h2>${m.title}</h2>
        <div class="note">${(NOTES[m.id]||[])[0]||""}</div>
        <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap">
          <button class="btn" onclick="revision('${m.id}')">Revision</button>
          <button class="btn primary" onclick="startQuiz('${m.id}')">Mock Exam</button>
        </div>
      </div>
    `).join("");
    app.innerHTML = `<section class="grid">${cards}</section>`;
  }

  function revision(id){
    const mod = MODULES.find(m=>m.id===id);
    const notes = NOTES[id] || [];
    const files = RES[id] || [];
    app.innerHTML = `
      <div class="card">
        <h2>${mod.title} — Revision</h2>
        ${notes.length ? notes.map(n=>`<div class="note">${n}</div>`).join("") : `<div class="note">No notes yet.</div>`}
        ${ files.length ? `
          <div class="card" style="margin-top:12px">
            <h3>Resources</h3>
            <ul>
              ${files.map(r=>`<li>
                <button class="btn" onclick="openInline('${r.file}')">View</button>
                <span class="muted" style="margin-left:8px">${r.label}</span>
              </li>`).join("")}
            </ul>
            <p class="muted">Viewing only. Browser toolbars may still appear; screenshots can’t be fully prevented.</p>
          </div>` : ``}
        <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap">
          <button class="btn primary" onclick="startQuiz('${id}')">Start Mock</button>
          <button class="btn" onclick="home()">← Back</button>
        </div>
      </div>
    `;
  }

  // --- Simple quiz engine ---
  function state(pool,title){ return { idx:0, order:shuffle([...pool.keys()]), pool, answers:{}, title }; }
  function startQuiz(id){
    const qs = (QB[id]||[]).map((q,i)=>({...q,_id:`${id}_${i}`}));
    if(!qs.length){ alert("No questions in this module yet."); return; }
    window._q = state(qs, `${MODULES.find(m=>m.id===id).title} — Mock`);
    renderQ();
  }
  function renderQ(){
    const s=window._q; if(!s)return;
    const i=s.order[s.idx], q=s.pool[i], cur=s.idx+1, total=s.pool.length, sel=s.answers[q._id]||[];
    const opts = (q.type==="multi")
      ? q.options.map((o,idx)=>`<label class="opt"><input type="checkbox" ${sel.includes(idx)?"checked":""} onchange="toggleMulti('${q._id}',${idx})"/> ${o}</label>`).join("")
      : q.options.map((o,idx)=>`<label class="opt"><input type="radio" name="opt" ${sel.includes(idx)?"checked":""} onchange="pickOne('${q._id}',${idx})"/> ${o}</label>`).join("");

    app.innerHTML = `
      <div class="card">
        <h2>${s.title} (${cur}/${total})</h2>
        <b>${q.q}</b><div>${opts}</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn" onclick="prevQ()">Back</button>
          <button class="btn" onclick="nextQ()">Next</button>
          <button class="btn primary" onclick="submitQ()">Submit</button>
        </div>
        <p class="muted" style="margin-top:8px">${q.type==="multi"?"Select all that apply":"Select one"}.</p>
      </div>`;
  }
  function pickOne(id,idx){const s=window._q;s.answers[id]=[idx];renderQ();}
  function toggleMulti(id,idx){const s=window._q;const set=new Set(s.answers[id]||[]);set.has(idx)?set.delete(idx):set.add(idx);s.answers[id]=[...set].sort((a,b)=>a-b);renderQ();}
  function nextQ(){const s=window._q;if(s.idx<s.pool.length-1)s.idx++;renderQ();}
  function prevQ(){const s=window._q;if(s.idx>0)s.idx--;renderQ();}
  function submitQ(){const s=window._q;let correct=0;s.pool.forEach(q=>{const a=s.answers[q._id]||[],ans=(q.answer||[]).slice().sort((x,y)=>x-y);const ok=a.length===ans.length&&a.every((v,i)=>v===ans[i]);if(ok)correct++;});alert("Score: "+correct+"/"+s.pool.length);home();}

  // --- Boot after DOM is ready (ensures rendering) ---
  window.addEventListener('DOMContentLoaded', () => {
    home();
    console.log("PlumbWise app.js loaded");
  });

  // --- Stripe Subscribe ---
  async function subscribe() {
    const email = prompt("Enter your email to subscribe (receipt will be sent here):");
    if (!email) return;
    try {
      const res = await fetch("/api/checkout", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email })
      });
      const data = await res.json();
      if (data.url) window.location = data.url;
      else alert("Checkout failed: " + (data.error || "Unknown error"));
    } catch { alert("Network error starting checkout."); }
  }
  </script>

  <!-- PWA: register service worker -->
  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("/sw.js").catch(()=>{});
    }
  </script>
</body>
</html>
