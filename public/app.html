<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>PlumbWise — Revision, Resources & Mocks</title>
  <style>
    html,body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:#0f172a;color:#e5e7eb}
    .wrap{max-width:960px;margin:0 auto;padding:18px}
    .card{background:#0b1223;border:1px solid #1f2a44;border-radius:12px;padding:16px;margin:14px 0}
    .btn{display:inline-block;padding:10px 14px;border:1px solid #27324f;border-radius:10px;text-decoration:none;color:#e5e7eb;background:#111a33;cursor:pointer}
    .btn.primary{background:#2563eb;border-color:#2563eb}
    .btn.primary:hover{background:#1e4fd1}
    .muted{color:#94a3b8}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px}
    .note{background:#0d172f;border:1px solid #223055;padding:12px;border-radius:10px}
    ul{margin:0;padding-left:20px;line-height:1.8}
    li{margin:4px 0}
    .opt{display:block;margin:8px 0}
    /* Inline viewer */
    .viewer-modal{position:fixed;inset:0;background:#000a;display:flex;align-items:center;justify-content:center;z-index:9999}
    .viewer-box{background:#0b1223;border:1px solid #1f2a44;border-radius:12px;width:min(1000px,95vw);height:min(90vh,850px);position:relative;overflow:hidden}
    .viewer-top{position:absolute;top:8px;right:8px;display:flex;gap:8px;z-index:2}
    .wm{position:absolute;inset:0;pointer-events:none;display:flex;align-items:center;justify-content:center;
        color:#ffffff1f;font-size:60px;font-weight:800;letter-spacing:2px;transform:rotate(-20deg);z-index:1}
    .pdf-embed{position:absolute;inset:0;border:0;width:100%;height:100%;z-index:0}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="card">
      <a class="btn" href="/">← Home</a>
      <h1>PlumbWise — Revision, Resources & Mock Exams</h1>
      <p class="muted">Open a module → Revision to view resources. Downloads are discouraged.</p>

      <!-- NEW: Subscribe button -->
      <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap">
        <button class="btn primary" onclick="subscribe()">Subscribe (£5.99/mo)</button>
      </div>
      <!-- /NEW -->
    </header>
    <main id="app"></main>
  </div>

  <script>
  // Soft block right click
  document.addEventListener('contextmenu', e => e.preventDefault());

  const MODULES = [
    { id: "hs",   title: "Health & Safety" },
    { id: "elec", title: "Electrical" },
    { id: "sci",  title: "Scientific Principles" },
    { id: "proc", title: "Plumbing Processes" },
    { id: "cold", title: "Cold Water" },
    { id: "hot",  title: "Hot Water" },
    { id: "ch",   title: "Central Heating" },
    { id: "san",  title: "Sanitation" },
    { id: "drn",  title: "Drainage" },
    { id: "comm", title: "Communications" },
    { id: "wr",   title: "Water Regulations" }
  ];

  const NOTES = {
    hs:["PPE, COSHH, permits, safe isolation."],
    elec:["RCDs, bonding/earthing, prove–test–prove."],
    sci:["Pressure≈ρgh; 10 m head≈1 bar; expansion control."],
    proc:["Measure, deburr/clean, heat fitting (not solder), press-fit jaw/profile."],
    cold:["Isolation, DCV/backflow, avoid dead legs."],
    hot:["Store ~60°C+, TMVs, unvented safety set & tundish."],
    ch:["Sealed systems: expansion vessel, PRV, inhibitor, balance."],
    san:["50 mm water seal, venting/anti-siphon, correct falls."],
    drn:["100 mm pipe ≈ 18–90 mm/m fall, rodding points at changes."],
    comm:["Confirm scope/changes in writing, keep photos/test records."],
    wr:["WRAS fittings, backflow categories, notify where required."]
  };

  // FULL resources list — ensure these files exist under /public/resources/<module>/
  const RES = {
    hs: [
      { label: "6035 Health and Safety PowerPoint 1", file: "/resources/hs/6035 Health and safety powerpoint 1.pdf" },
      { label: "6035 Health and Safety PowerPoint 2", file: "/resources/hs/6035 Health and safety powerpoint 2.pdf" },
      { label: "6035 Health and Safety PowerPoint 3", file: "/resources/hs/6035 Health and safety powerpoint 3.pdf" },
      { label: "6035 Health and Safety PowerPoint 4", file: "/resources/hs/6035 Health and safety powerpoint 4.pdf" },
      { label: "6035 Health and Safety PowerPoint 5", file: "/resources/hs/6035 Health and safety powerpoint 5.pdf" },
      { label: "6035 Health and Safety PowerPoint 6", file: "/resources/hs/6035 Health and safety powerpoint 6.pdf" },
      { label: "Health & Safety Revision Study Pack (2014)", file: "/resources/hs/Health and Safety Revision Study Pack 2014 reduced.pdf" }
    ],
    elec: [
      { label: "6035 Electrical 1", file: "/resources/elec/6035 electrical 1.pdf" },
      { label: "6035 Electrical 2", file: "/resources/elec/6035 electrical 2.pdf" },
      { label: "6035 Electrical 3", file: "/resources/elec/6035 electrical 3.pdf" },
      { label: "6035 Electrical 5", file: "/resources/elec/6035 electrical 5.pdf" },
      { label: "6035 Electrical 6", file: "/resources/elec/6035 electrical 6.pdf" }
    ],
    sci: [
      { label: "Science 1", file: "/resources/sci/6035_l2u203_Science 1.pdf" },
      { label: "Science 2", file: "/resources/sci/6035_l2u203_Science 2.pdf" },
      { label: "Science 3", file: "/resources/sci/6035_l2u203_Science 3.pdf" },
      { label: "Science 4", file: "/resources/sci/6035_l2u203_Science 4.pdf" },
      { label: "Science 5", file: "/resources/sci/6035_l2u203_Science 5.pdf" },
      { label: "Science 6", file: "/resources/sci/6035_l2u203_Science 6.pdf" },
      { label: "Key Plumbing Principles Level 2 Revision", file: "/resources/sci/Key Plumbing Principles level 2 Revision.pdf" }
    ],
    proc: [
      { label: "Unit 204 Outcome 1", file: "/resources/proc/6035_l2u204_ppt_outcome1.pdf" },
      { label: "Unit 204 Outcome 3", file: "/resources/proc/6035_l2u204_ppt_outcome3.pdf" },
      { label: "Unit 204 Outcome 4", file: "/resources/proc/6035_l2u204_ppt_outcome4.pdf" },
      { label: "Unit 204 Outcome 5", file: "/resources/proc/6035_l2u204_ppt_outcome5.pdf" },
      { label: "Unit 204 Outcome 6", file: "/resources/proc/6035_l2u204_ppt_outcome6.pdf" },
      { label: "Unit 204 Outcome 7", file: "/resources/proc/6035_l2u204_ppt_outcome7.pdf" }
    ],
    cold: [
      { label: "Unit 205 Outcome 1", file: "/resources/cold/6035_l2u205_ppt_outcome1.pdf" },
      { label: "Unit 205 Outcome 2", file: "/resources/cold/6035_l2u205_ppt_outcome2.pdf" },
      { label: "Unit 205 Outcome 3", file: "/resources/cold/6035_l2u205_ppt_outcome3.pdf" },
      { label: "Unit 205 Outcome 4", file: "/resources/cold/6035_l2u205_ppt_outcome4.pdf" },
      { label: "Unit 205 Outcome 5", file: "/resources/cold/6035_l2u205_ppt_outcome5.pdf" },
      { label: "Unit 205 Outcome 6", file: "/resources/cold/6035_l2u205_ppt_outcome6.pdf" }
    ],
    hot: [
      { label: "Unit 206 Outcome 1 (Part 1)", file: "/resources/hot/6035_l2u206_ppt_outcome1_part_1.pdf" },
      { label: "Unit 206 Outcome 1 (Part 2)", file: "/resources/hot/6035_l2u206_ppt_outcome1_part_2.pdf" },
      { label: "Unit 206 Outcome 2", file: "/resources/hot/6035_l2u206_ppt_outcome2.pdf" },
      { label: "Unit 206 Outcome 3 (Part 1)", file: "/resources/hot/6035_l2u206_ppt_outcome3_part_1.pdf" },
      { label: "Unit 206 Outcome 3 (Part 2)", file: "/resources/hot/6035_l2u206_ppt_outcome3_part_2.pdf" },
      { label: "Unit 206 Outcome 4", file: "/resources/hot/6035_l2u206_ppt_outcome4.pdf" },
      { label: "Unit 206 Outcome 5", file: "/resources/hot/6035_l2u206_ppt_outcome5.pdf" },
      { label: "Unit 206 Outcome 6", file: "/resources/hot/6035_l2u206_ppt_outcome6.pdf" }
    ],
    ch: [
      { label: "Unit 208 Outcome 1 (Part 1)", file: "/resources/ch/6035_l2u208_ppt_outcome1_part_1.pdf" },
      { label: "Unit 208 Outcome 1 (Part 2)", file: "/resources/ch/6035_l2u208_ppt_outcome1_part_2.pdf" },
      { label: "Unit 208 Outcome 1 (Part 3)", file: "/resources/ch/6035_l2u208_ppt_outcome1_part_3.pdf" },
      { label: "Unit 208 Outcome 2", file: "/resources/ch/6035_l2u208_ppt_outcome2.pdf" },
      { label: "Unit 208 Outcome 3 (Part 1)", file: "/resources/ch/6035_l2u208_ppt_outcome3_part_1.pdf" },
      { label: "Unit 208 Outcome 3 (Part 2)", file: "/resources/ch/6035_l2u208_ppt_outcome3_part_2.pdf" },
      { label: "Unit 208 Outcome 4", file: "/resources/ch/6035_l2u208_ppt_outcome4.pdf" }
    ],
    san: [
      { label: "Unit 209 Outcome 1 (Part 1)", file: "/resources/san/6035_l2u209_ppt_outcome1_part_1.pdf" },
      { label: "Unit 209 Outcome 1 (Part 2)", file: "/resources/san/6035_l2u209_ppt_outcome1_part_2.pdf" },
      { label: "Unit 209 Outcome 1 (Part 3)", file: "/resources/san/6035_l2u209_ppt_outcome1_part_3.pdf" },
      { label: "Unit 209 Outcome 2 (Part 1)", file: "/resources/san/6035_l2u209_ppt_outcome2_part_1.pdf" },
      { label: "Unit 209 Outcome 2 (Part 2)", file: "/resources/san/6035_l2u209_ppt_outcome2_part_2.pdf" },
      { label: "Unit 209 Outcome 3", file: "/resources/san/6035_l2u209_ppt_outcome3.pdf" },
      { label: "Unit 209 Outcome 4 (Part 1)", file: "/resources/san/6035_l2u209_ppt_outcome4_part_1.pdf" },
      { label: "Unit 209 Outcome 4 (Part 2)", file: "/resources/san/6035_l2u209_ppt_outcome4_part_2.pdf" },
      { label: "Unit 209 Outcome 4 (Part 3)", file: "/resources/san/6035_l2u209_ppt_outcome4_part_3.pdf" },
      { label: "Unit 209 Outcome 4 (Part 4)", file: "/resources/san/6035_l2u209_ppt_outcome4_part_4.pdf" }
    ],
    drn: [],
    comm: [
      { label: "6035 Communication 1", file: "/resources/comm/6035 communication 1.pdf" },
      { label: "6035 Communication 2", file: "/resources/comm/6035 communication 2.pdf" },
      { label: "6035 Communication 3", file: "/resources/comm/6035 communication 3.pdf" },
      { label: "Effective Working Relationships Level 2 Revision", file: "/resources/comm/Effective Working Relationships Level 2 Revision.pdf" }
    ],
    wr: []
  };

  const QB = {
    hs:[{ q:"First step before hot works?", type:"mcq", options:["Warn others","Open window","Risk assessment/permit","Put on gloves"], answer:[2], why:"Control hazards before starting." }],
    elec:[{ q:"Safe isolation requires:", type:"multi", options:["Prove tester","Test supply","Lock-off","Skip proving"], answer:[0,1,2], why:"Prove, test, secure." }],
    sci:[{ q:"1 m head ≈ ?", type:"mcq", options:["0.01 bar","0.1 bar","1 bar","10 bar"], answer:[1], why:"~10 m ≈ 1 bar." }]
  };

  const app = document.getElementById("app");
  const shuffle = a => { for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; };

  // EDGE-FRIENDLY VIEWER (embed + fallback)
  async function openInline(path){
    const encoded = encodeURI(path);
    try {
      const head = await fetch(encoded, { method: "HEAD" });
      if (!head.ok) {
        alert("That resource isn’t on the server at:\n" + path + "\n\nCheck capitals/spaces and that it lives under /public" + path);
        return;
      }
    } catch (e) {
      alert("Couldn’t reach the file. Check network and the exact path:\n" + path);
      return;
    }

    const url = encoded + '#toolbar=0&navpanes=0&scrollbar=0&view=FitH';

    // Create modal
    const modal = document.createElement('div');
    modal.className = 'viewer-modal';
    modal.innerHTML = `
      <div class="viewer-box">
        <div class="viewer-top">
          <button class="btn" onclick="this.closest('.viewer-modal').remove()">Close</button>
        </div>
        <div class="wm">PLUMBWISE</div>
        <embed class="pdf-embed" src="${url}" type="application/pdf" />
      </div>`;
    document.body.appendChild(modal);

    // Edge fallback: if embed doesn't render, open in new tab
    const isEdge = navigator.userAgent.includes("Edg");
    setTimeout(() => {
      const embed = modal.querySelector('.pdf-embed');
      const rendered = embed && embed.offsetHeight > 0;
      if (isEdge && !rendered) {
        window.open(url, "_blank", "noopener,noreferrer");
        modal.remove();
      }
    }, 400);
  }

  // Screens
  function home(){
    const cards = MODULES.map(m=>`
      <div class="card">
        <h2>${m.title}</h2>
        <div class="note">${(NOTES[m.id]||[])[0]||""}</div>
        <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap">
          <button class="btn" onclick="revision('${m.id}')">Revision</button>
          <button class="btn primary" onclick="startQuiz('${m.id}')">Mock Exam</button>
        </div>
      </div>
    `).join("");
    app.innerHTML = `<section class="grid">${cards}</section>`;
  }

  function revision(id){
    const mod = MODULES.find(m=>m.id===id);
    const notes = NOTES[id] || [];
    const files = RES[id] || [];
    app.innerHTML = `
      <div class="card">
        <h2>${mod.title} — Revision</h2>
        ${notes.length ? notes.map(n=>`<div class="note">${n}</div>`).join("") : `<div class="note">No notes yet.</div>`}
        ${ files.length ? `
          <div class="card" style="margin-top:12px">
            <h3>Resources</h3>
            <ul>
              ${files.map(r=>`<li>
                <button class="btn" onclick="openInline('${r.file}')">View</button>
                <span class="muted" style="margin-left:8px">${r.label}</span>
              </li>`).join("")}
            </ul>
            <p class="muted">Viewing only. Browser toolbars may still appear; screenshots can’t be fully prevented.</p>
          </div>` : ``}
        <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap">
          <button class="btn primary" onclick="startQuiz('${id}')">Start Mock</button>
          <button class="btn" onclick="home()">← Back</button>
        </div>
      </div>
    `;
  }

  // Simple quiz engine
  function state(pool,title){ return { idx:0, order:shuffle([...pool.keys()]), pool, answers:{}, title }; }
  function startQuiz(id){
    const qs = (QB[id]||[]).map((q,i)=>({...q,_id:`${id}_${i}`}));
    if(!qs.length){ alert("No questions in this module yet."); return; }
    window._q = state(qs, `${MODULES.find(m=>m.id===id).title} — Mock`);
    renderQ();
  }
  function renderQ(){
    const s = window._q; if(!s) return;
    const i=s.order[s.idx], q=s.pool[i], total=s.pool.length, cur=s.idx+1, sel=s.answers[q._id]||[];
    const opts = (q.type==="multi")
      ? q.options.map((o,idx)=>`<label class="opt"><input type="checkbox" ${sel.includes(idx)?"checked":""} onchange="toggleMulti('${q._id}',${idx})"/> ${o}</label>`).join("")
      : q.options.map((o,idx)=>`<label class="opt"><input type="radio" name="opt" ${sel.includes(idx)?"checked":""} onchange="pickOne('${q._id}',${idx})"/> ${o}</label>`).join("");

    app.innerHTML = `
      <div class="card">
        <h2>${s.title} (${cur}/${total})</h2>
        <div class="q"><b>${q.q}</b><div class="options">${opts}</div></div>
        <div style="display:flex; gap:8px; flex-wrap:wrap">
          <button class="btn" onclick="prevQ()">Back</button>
          <button class="btn" onclick="nextQ()">Next</button>
          <button class="btn primary" onclick="submitQ()">Submit</button>
        </div>
        <p class="muted" style="margin-top:8px">${q.type==="multi" ? "Select all that apply" : "Select one"}.</p>
      </div>
    `;
  }
  function pickOne(id, idx){ const s=window._q; s.answers[id]=[idx]; renderQ(); }
  function toggleMulti(id, idx){
    const s=window._q; const set=new Set(s.answers[id]||[]);
    set.has(idx)?set.delete(idx):set.add(idx);
    s.answers[id]=[...set].sort((a,b)=>a-b); renderQ();
  }
  function nextQ(){ const s=window._q; if(s.idx<s.pool.length-1) s.idx++; renderQ(); }
  function prevQ(){ const s=window._q; if(s.idx>0) s.idx--; renderQ(); }
  function submitQ(){
    const s=window._q; let correct=0, total=s.pool.length, review=[];
    s.pool.forEach(q=>{
      const a=s.answers[q._id]||[];
      const ans=(q.answer||[]).slice().sort((x,y)=>x-y);
      const ok=a.length===ans.length && a.every((v,i)=>v===ans[i]);
      if(ok) correct++; else review.push(q);
    });
    const p = Math.round((correct/total)*100);
    app.innerHTML = `
      <div class="card">
        <h2>${s.title} — Results</h2>
        <p>Score: <b>${p}%</b> (${correct}/${total}) • Pass: 70%</p>
        <div style="display:flex; gap:8px; flex-wrap:wrap; margin:8px 0">
          <button class="btn" onclick="startQuiz('${s.pool[0]._id.split('_')[0]}')">Retake</button>
          <button class="btn" onclick="home()">Home</button>
        </div>
      </div>
      <div class="card">
        <h3>Review</h3>
        ${ review.length
            ? review.map(q=>{
                const corr = q.type==="mcq" ? q.options[q.answer[0]]
                                             : q.answer.map(i=>q.options[i]).join(", ");
                return `<div class="note" style="margin:8px 0"><b>${q.q}</b><br/>Correct: ${corr}<br/>Why: ${q.why||"See notes"}</div>`;
              }).join("")
            : "<div class='note'>Perfect!</div>"
        }
      </div>
    `;
  }

  // Expose
  window.revision = revision;
  window.startQuiz = startQuiz;
  window.nextQ = nextQ;
  window.prevQ = prevQ;
  window.pickOne = pickOne;
  window.toggleMulti = toggleMulti;
  window.submitQ = submitQ;
  window.openInline = openInline;

  // Boot
  home();

  // ====== NEW: Stripe Subscribe handler ======
  async function subscribe() {
    const email = prompt("Enter your email to subscribe (receipt will be sent here):");
    if (!email) return;

    try {
      const res = await fetch("/api/checkout", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email })
      });
      const data = await res.json();
      if (data.url) {
        window.location = data.url;
      } else {
        alert("Checkout failed: " + (data.error || "Unknown error"));
      }
    } catch (e) {
      alert("Network error starting checkout.");
    }
  }
  // ===========================================
  </script>
</body>
</html>
