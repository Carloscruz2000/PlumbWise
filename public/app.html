<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>

  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#1e3a8a">

  <!-- iOS PWA Support -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">

  <title>PlumbWise — Revision, Resources & Mocks</title>

  <style>
    html,body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:#0f172a;color:#e5e7eb}
    .wrap{max-width:960px;margin:0 auto;padding:18px}
    .card{background:#0b1223;border:1px solid #1f2a44;border-radius:12px;padding:16px;margin:14px 0}
    .btn{display:inline-block;padding:10px 14px;border:1px solid #27324f;border-radius:10px;text-decoration:none;color:#e5e7eb;background:#111a33;cursor:pointer}
    .btn.primary{background:#2563eb;border-color:#2563eb}
    .btn.primary:hover{background:#1e4fd1}
    .muted{color:#94a3b8}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px}
    .note{background:#0d172f;border:1px solid #223055;padding:12px;border-radius:10px}
    ul{margin:0;padding-left:20px;line-height:1.8}
    li{margin:4px 0}
    .opt{display:block;margin:8px 0}
    .viewer-modal{position:fixed;inset:0;background:#000a;display:flex;align-items:center;justify-content:center;z-index:9999}
    .viewer-box{background:#0b1223;border:1px solid #1f2a44;border-radius:12px;width:min(1000px,95vw);height:min(90vh,850px);position:relative;overflow:hidden}
    .viewer-top{position:absolute;top:8px;right:8px;display:flex;gap:8px;z-index:2}
    .wm{position:absolute;inset:0;pointer-events:none;display:flex;align-items:center;justify-content:center;
        color:#ffffff1f;font-size:60px;font-weight:800;letter-spacing:2px;transform:rotate(-20deg);z-index:1}
    .pdf-embed{position:absolute;inset:0;border:0;width:100%;height:100%;z-index:0}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="card">
      <a class="btn" href="/">← Home</a>
      <h1>PlumbWise — Revision, Resources & Mock Exams</h1>
      <p class="muted">Open a module → Revision to view resources.</p>

      <!-- Subscribe button -->
      <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap">
        <button class="btn primary" onclick="subscribe()">Subscribe (£5.99/mo)</button>
      </div>
    </header>
    <main id="app"></main>
  </div>

  <script>
  document.addEventListener('contextmenu', e => e.preventDefault());

  const MODULES = [
    { id: "hs",   title: "Health & Safety" },
    { id: "elec", title: "Electrical" },
    { id: "sci",  title: "Scientific Principles" },
    { id: "proc", title: "Plumbing Processes" },
    { id: "cold", title: "Cold Water" },
    { id: "hot",  title: "Hot Water" },
    { id: "ch",   title: "Central Heating" },
    { id: "san",  title: "Sanitation" },
    { id: "drn",  title: "Drainage" },
    { id: "comm", title: "Communications" },
    { id: "wr",   title: "Water Regulations" }
  ];

  const NOTES = {
    hs:["PPE, COSHH, permits, safe isolation."],
    elec:["RCDs, bonding/earthing, prove–test–prove."],
    sci:["Pressure≈ρgh; 10 m head≈1 bar; expansion control."],
    proc:["Measure, deburr/clean, heat fitting (not solder), press-fit jaw/profile."],
    cold:["Isolation, DCV/backflow, avoid dead legs."],
    hot:["Store ~60°C+, TMVs, unvented safety set & tundish."],
    ch:["Sealed systems: expansion vessel, PRV, inhibitor, balance."],
    san:["50 mm water seal, venting/anti-siphon, correct falls."],
    drn:["100 mm pipe ≈ 18–90 mm/m fall, rodding points at changes."],
    comm:["Confirm scope/changes in writing, keep photos/test records."],
    wr:["WRAS fittings, backflow categories, notify where required."]
  };

  // Example resources object — keep your full RES here
  const RES = { hs:[], elec:[], sci:[], proc:[], cold:[], hot:[], ch:[], san:[], drn:[], comm:[], wr:[] };

  const QB = {
    hs:[{ q:"First step before hot works?", type:"mcq", options:["Warn others","Open window","Risk assessment/permit","Put on gloves"], answer:[2], why:"Control hazards before starting." }]
  };

  const app = document.getElementById("app");
  const shuffle = a => { for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; };

  function home(){
    const cards = MODULES.map(m=>`
      <div class="card">
        <h2>${m.title}</h2>
        <div class="note">${(NOTES[m.id]||[])[0]||""}</div>
        <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap">
          <button class="btn" onclick="revision('${m.id}')">Revision</button>
          <button class="btn primary" onclick="startQuiz('${m.id}')">Mock Exam</button>
        </div>
      </div>
    `).join("");
    app.innerHTML = `<section class="grid">${cards}</section>`;
  }

  function revision(id){
    const mod = MODULES.find(m=>m.id===id);
    const notes = NOTES[id] || [];
    const files = RES[id] || [];
    app.innerHTML = `
      <div class="card">
        <h2>${mod.title} — Revision</h2>
        ${notes.length ? notes.map(n=>`<div class="note">${n}</div>`).join("") : `<div class="note">No notes yet.</div>`}
        ${ files.length ? `
          <div class="card" style="margin-top:12px">
            <h3>Resources</h3>
            <ul>
              ${files.map(r=>`<li>
                <button class="btn" onclick="openInline('${r.file}')">View</button>
                <span class="muted" style="margin-left:8px">${r.label}</span>
              </li>`).join("")}
            </ul>
          </div>` : ``}
        <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap">
          <button class="btn primary" onclick="startQuiz('${id}')">Start Mock</button>
          <button class="btn" onclick="home()">← Back</button>
        </div>
      </div>
    `;
  }

  function startQuiz(id){
    alert("Mock exam for " + id + " coming soon");
  }

  home();

  // Stripe Subscribe handler
  async function subscribe() {
    const email = prompt("Enter your email to subscribe (receipt will be sent here):");
    if (!email) return;
    try {
      const res = await fetch("/api/checkout", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email })
      });
      const data = await res.json();
      if (data.url) {
        window.location = data.url;
      } else {
        alert("Checkout failed: " + (data.error || "Unknown error"));
      }
    } catch (e) {
      alert("Network error starting checkout.");
    }
  }

  // Inline resource viewer
  async function openInline(path){
    const url = encodeURI(path);
    const modal = document.createElement('div');
    modal.className = 'viewer-modal';
    modal.innerHTML = `
      <div class="viewer-box">
        <div class="viewer-top">
          <button class="btn" onclick="this.closest('.viewer-modal').remove()">Close</button>
        </div>
        <div class="wm">PLUMBWISE</div>
        <embed class="pdf-embed" src="${url}" type="application/pdf" />
      </div>`;
    document.body.appendChild(modal);
  }
  </script>

  <!-- Service Worker Register -->
  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("/sw.js").catch(() => {
        console.warn("Service worker registration failed.");
      });
    }
  </script>
</body>
</html>
